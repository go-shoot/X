<title>陀螺景品⬧Prizes</title>
<script src=../include/common.js></script>
<script src=https://aeoq.github.io/diamond-grid/script.js type=module></script>
<link rel=stylesheet href=../include/component.css>
<link rel=stylesheet href=prize.css>

<nav>
    <menu>
        <li><a href="../products/" data-icon=""></a>
        <li><a href="../parts/?blade=一體" data-icon=""></a>
    </menu>
    <div class="led">
        <a href="https://beyblade.takaratomy.co.jp/beyblade-x/news/news_stickerlist.html">
            <img src="https://beyblade.takaratomy.co.jp/beyblade-x/news/_image/news_stickerlist_12.png">
            <span>各款貼紙</span>
        </a>
    </div>
</nav>

<main>
    <diamond-grid></diamond-grid>
</main>

<script type="module">
import { Bey } from '../include/bey.js'
const Prize = () => Prize.before().then(Prize.display).then(Prize.after);
Object.assign(Prize, {
    before: () => Promise.all([DB.get('meta','part'), DB.get.PARTS(), fetch('../db/prod-keihin.json')])
        .then(([meta, parts, resp]) => Bey.import(meta.general, parts) && resp.json()),

    display: keihins => Q('diamond-grid').append(...Keihin.all = keihins.map(k => new Keihin(k))),
    after: () => Prize.filter(),
    filter () {
        Q('nav div').append(...E.checkboxes(Object.keys(Keihin.type).map(t => ({id: `keihin-${t}`, checked: true}) )));
        Q('nav').onchange = () => {
            let show = Q('nav input', []).filter(i => i.checked).map(i => i.id);
            Keihin.all.forEach(k => k.hidden = !show.includes(k.classList[0]));
        };
    }
})
class Keihin {
    constructor({type, note, link, date, code, bey, ver, img}) {
        let names = new Bey([, , bey]);        
        return E(`li.keihin-${type}`, [
            E('b', Keihin.type[type]), E('p', link ? [E('a', {href: link, innerHTML: note})] : note),
            E('div', [
                E('figure', [E('img', {src: img[0], style: img[1]})]), 
                E('h5', [
                    code ? E('span.code', code) : '', 
                    E('span', names.jap.replace('-', '‑')), 
                    E('small', {innerHTML: [ver?.[0] ?? '', names.only ? `（${names.only}）` : ''].filter(t => t).join('<br>')})
                ]),
            ]),
            E('i', [
                names.chi.replace('-', '‑'), 
                E('small', {innerHTML: [ver?.[1] ?? ''].filter(t => t).join(' ')})
            ]),
            E('time', date.replace('-','‒'))
        ]);
    }
    static type = {t: '比賽', d: '抽獎', m: '限定商品', g: '贈品'}
    static all = []
}
onclick = ev => {
    let h5 = ev.target.closest('h5')?.cloneNode(true);
    if (!h5) return;
    h5.Q('.code')?.remove();
    navigator.clipboard.writeText([...h5.children].map(el => el.innerText.replace(' ', '')).join(' '));
}
location.hash && Q(location.hash)?.setAttribute('open', true);

Q('nav').after(DB(Prize));
</script>
