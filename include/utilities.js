import DB from "./DB.js";
import { Bey, Preview, Markup } from "./bey.js";

class FilterLED {
    constructor(classes, targets, custom) {
        let form = E('form.LED');
        E(form).set(E.checkboxes(classes.map(c => ({id: c, checked: true}) )), {
            onchange: () => this.filter(form, typeof targets == 'string' ? Q(targets) : targets),
            onreset: () => this.reset(form, typeof targets == 'string' ? Q(targets) : targets)
        });
        custom?.(form);
        return form;
    }
    filter (form, targets) {
        let show = [...form.elements].filter(i => i.checked).map(i => `.${i.id}`).join(',');
        targets?.forEach(el => el.hidden = !el.matches(show));
    }
    reset (form, targets) {
        [...form.elements].forEach(input => input.checked = true);
        targets?.forEach(el => el.hidden = false);
    }
}
class Shohin {
    constructor({code: header, name, imgs, desc, type}) {
        imgs ??= [];
        let content = [desc ?? []].flat().reduce((arr, n, i) => arr.toSpliced(2 * i + 1, 0, n), imgs)
            .map(srcORtext => /^(https?:)?\/\//.test(srcORtext) ? 
                E('figure', [E('a', 'ðŸ–¼ï¸', {href: srcORtext.src}), E('img', {src: srcORtext})]) : 
                E('p', {innerHTML: Markup.spacing(srcORtext).replaceAll('-', 'â€‘')})
            );
        return E('div', [
            E('h5', [type ? E(`ruby.below.${type}`, [
                E('img', {src: `img/types.svg#${type}`}), 
                E('rt', Shohin.type[type])
            ]) : '', header]),
            name ? E('h4', {innerHTML: name?.replaceAll('-', 'â€‘')}) : '',
            ...content
        ], {classList: [`scroller`, Shohin.classes.find(header, {default: 'Lm'})]});
    }
    static type = {att: 'ATTACK', bal: 'BALANCE', sta: 'STAMINA', def: 'DEFENSE'};
    static classes = new O([
        [/(stadium|entry) set/i, 'SS'],
        [/çµ„åˆ|Set/i, 'St'],
        [/Starter/i, 'S'],
        [/Random/i, 'RB'],
        [/Booster/i, 'B'],
        [/.XG?-/, 'others'],
    ])
    static after = () => Q('.scroller:has(h4)', []).forEach(div => {
        let header = div.Q('h5').innerText;
        if (!/XG?-\d+/.test(header)) return;
        let [code, cat] = header.match(/(?<=\n?).+$/)[0].split(/(?<=\d) /);
        let figures = div.Q('figure', []);
        figures.push(...new Preview('index', code.replace('-', ''), cat).map(img => 
            E('figure', [E('a', 'ðŸ–¼ï¸', {href: img.src}), img])
        ));
        div.replaceChildren(
            div.Q('h5'), div.Q('h4'), 
            ...div.Q('p', []).reduce((arr, n, i) => arr.toSpliced(2 * i + 1, 0, n), figures)
        );
    })
    
}
class Keihin {
    constructor({type, note, link, date, code, bey, ver, img: [src, style]}) {
        let names = new Bey([, , bey]);   
        return E(`article.keihin-${type}`, [
            E('em', Keihin.type[type]), 
            E('p', link ? E('a', {href: link}, note) : note),
            E('div', [
                E('figure>img', {src, style}), 
                E('h4', {lang: 'ja'}, [
                    E('code', code || ''), 
                    E('span', names.jap), 
                    E('small', {innerHTML: [ver?.[0] ?? '', names.only ? `ï¼ˆ${names.only}ï¼‰` : ''].filter(t => t).join('<br>')})
                ]),
            ]),
            E('h4', {lang: 'zh'}, [names.chi, E('small', [ver?.[1] ?? ''].filter(t => t).join(' '))]),
            E('time', date.replace('-','â€’'))
        ]);
    }
    static type = new O({t: 'æ¯”è³½', d: 'æŠ½çŽ', m: 'é™å®šå•†å“', g: 'è´ˆå“'})
}

const Glossary = async (where = document) => {
    if (!Q('#glossary')) {
        addEventListener('click', ev => {
            let clicked = ev.composedPath()[0];
            clicked.tagName == 'U' && Glossary.lookup(ev, clicked.innerText);
        }, {capture: true});
        Q('body').append(E('aside#glossary', {popover: 'hint'}));
    }
    let p = [where.Q('p'), where.Q('x-part', []).map(part => part.shadowRoot.Q('p'))].flat(9).filter(el => el);
    if (!p.length) return;
    Glossary.search(p, await DB.get('meta', 'glossary'));    
}
Object.assign(Glossary, {
    search: (texts, glossary) => texts.forEach(p => {
        const walker = document.createTreeWalker(p, NodeFilter.SHOW_TEXT, 
            node => NodeFilter[node.parentElement.tagName == 'U' ? 'FILTER_REJECT' : 'FILTER_ACCEPT']);
        let node;
        while (node = walker.nextNode()) {
            const texts = node.nodeValue.split(/(\w[\w ]*\w)/);
            if (texts.length <= 1) continue;
            const fragment = new DocumentFragment();
            fragment.append(...texts.map(text => text in glossary ? E('u', text) : new Text(text)));
            node.replaceWith(fragment);
        }
    }),    
    lookup: async (ev, term) => {
        ev.stopPropagation();
        clearTimeout(Glossary.timer);
        let aside = Q('#glossary');
        aside.innerHTML = '';
        let [jap, def] = (await DB.get('meta', 'glossary'))[term];  //ev.target changes after await
        E(aside).set({
            '--left': `${ev.clientX}px`, '--top': `${ev.clientY}px`
        }, [
            E('dfn', [
                E('ruby', term, E('rt', jap.split('&')[0])),
                'â€†', jap.split('&')[1] ?? ''
            ]), Markup.spacing(def)
        ]);
        aside.showPopover();
        Glossary.timer = setTimeout(() => {
            aside.innerHTML = '';
            aside.hidePopover();
        }, 3000);
    },
});
export {FilterLED, Shohin, Keihin, Glossary}