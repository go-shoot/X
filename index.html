<title>éå®˜æ–¹è³‡è¨Šç«™â¬§Unofficial site</title>
<meta name=description content="æœ€æ–°æ—¥æœ¬é™€èºæƒ…å ±ã€æ‰€æœ‰éƒ¨ä»¶åœ–é‘‘ã€é™é‡ç”£å“ï¼Œéƒ½ä¸€æ‡‰ä¿±å…¨ã€‚">
<script defer src=include/common.js></script>
<link rel=stylesheet href=index.css>
<link rel=stylesheet href=include/component.css>
<img src="https://beyblade.takaratomy.co.jp/anime/_image/kv_chara.png" hidden>

<input>

<header>
    <h1 hidden>æˆ°é¬¥é™€èºâ€†Xâ¬§çˆ†æ—‹é™€èºâ€†Xâ¬§ãƒ™ã‚¤ãƒ–ãƒ¬ãƒ¼ãƒ‰â€†Xâ¬§Beyblade X</h1>
    <img src="https://beyblade.takaratomy.co.jp/_image/cmn_logo.svg" alt="æˆ°é¬¥é™€èºâ€†Xâ¬§çˆ†æ—‹é™€èºâ€†Xâ¬§ãƒ™ã‚¤ãƒ–ãƒ¬ãƒ¼ãƒ‰â€†Xâ¬§Beyblade X">
    <h2>éå®˜æ–¹è³‡è¨Šç«™</h2>
</header>

<section id="search">
    <search>
        <a href=products/ >î€â€†å•†å“</a>
        <a href=parts/ >î€ƒâ€†éƒ¨ä»¶</a>
        <a href=prize/ >î€‚â€†æ™¯å“</a>
        <a href="customize/sheet.html">î€ªâ€†è¨­è¨ˆå™¨</a>
        <input type="search">
    </search>
    <ol class="parts"></ol>
    <ol class="beys"></ol>
    <ol class="links"></ol>
</section>

<section id=products><h3>æœ€æ–°å•†å“</h3></section>

<section id=reboot>
    <div>
        å¦‚åœ¨æœ¬ç¶²é‡ä¸Šå•é¡Œ<p><i id=reset>&#xe010;</i><span>é‡è¨­å„²å­˜</span><i></i></p>
    </div>
    <a href="../burst/" id=bbb><img src="img/system-BBB.png"></a>
</section>

<footer>
    å°æ–¼æœ¬ç¶²æ‰€è¼‰è³‡æ–™çš„æº–ç¢ºæ€§æˆ–å®Œæ•´æ€§ï¼Œè£½ä½œè€…ä¸æœƒä½œä»»ä½•ä¿è­‰æˆ–è²æ˜ï¼Œæˆ–å› æä¾›æˆ–ä½¿ç”¨æ­¤ç¶²è³‡æ–™è€Œç›´æ¥æˆ–é–“æ¥å¼•è‡´çš„ä»»ä½•æå¤±ã€æå£æˆ–å‚·å®³ï¼Œè² ä¸Šä»»ä½•è²¬ä»»ã€‚
    <br>Developed and Designed by V Man (MKK). 2023â€“.
</footer>

<link rel="stylesheet" href="include/part.css">

<script type="module">
import DB from './include/DB.js'
import {Markup, Preview} from './include/bey.js'
import {Part} from './include/part.js'
import Fuse from 'https://cdn.jsdelivr.net/npm/fuse.js@7.1.0/dist/fuse.min.mjs'
let CACHE;
Q('[type=search]').oninput = ev => {
    Preview.reset();
    if (!ev.target.value.trim()) return;

    (CACHE ? Promise.resolve() : 
        Promise.all([DB.get.essentials(false), DB.get('meta', 'search'), DB.get('product', 'beys')])
        .then(([[meta, parts], links, beys]) => {
            Part.import(meta.general, DB.transform(parts));
            links.push(
                ...Object.entries(meta.grouped.blade.ä¸€é«”.group).map(([line, {label}]) => ({                        
                    keywords: ["é›¶ä»¶","éƒ¨ä»¶","çµ„ä»¶","åœ–é‘‘","åˆƒæ“Šç’°","é‹¼éµæˆ°åˆƒ","Blade", line, label],
                    href: `parts/?blade#${line}`, text: label
                })),
                ...meta.grouped.blade.filter(([line]) => line.endsWith('X'))
                    .flatMap(([line, obj]) => obj.title.flatMap(([group, title]) => ({ 
                        keywords: ["é›¶ä»¶","éƒ¨ä»¶","çµ„ä»¶","åœ–é‘‘", line, title],
                        href: `parts/?blade=${line}#${group}`, text: title.match(/(?<=[â¬§ã€‘])[^â¬§]+$/)[0]
                })))
            );
            window.CACHE = CACHE = {links, beys: [...new Set(beys.map(([code]) => code ))]};
            return Promise.all(parts.flatMap(([, parts]) => parts.map(p => new Part(p).revise())));
        })
        .then(parts => CACHE.parts = parts.map(p => p.push({all: [...p].flat()})) )
    ).then(() => {
        Q('#search .parts').replaceChildren(...new Fuse(CACHE.parts, {keys: ['abbr', 'all'], threshold: .3})
            .search({$or: [
                {abbr: ev.target.value.trim()}, 
                {$and: ev.target.value.split(/(?=\W)/).map(t => ({all: t.trim()}) )}
            ]}).slice(0, 10)
            .map(({item}) => E(`li>button.${item.comp}.${item.line || item.group}`, 
                Markup('cell', item.names?.chi || item.abbr),
                {onclick: () => new Preview(['tile', 'cell'], item.path)}
            ))
        );
        Q('#search .beys').replaceChildren(...new Fuse(CACHE.beys, {threshold: 0})
            .search(ev.target.value)
            .map(({item}) => E('li>button', item, {onclick: () => new Preview(['cell', 'image'], item)}))
        );
        Q('#search .links').replaceChildren(...new Fuse(CACHE.links, {keys: ['keywords', 'text'], threshold: .4})
            .search(ev.target.value).slice(0, 5)
            .map(({item}) => E('li>a', {href: item.href, innerText: item.text, target: item.href.startsWith('//') ? '_blank' : ''}))
        );
    })
}
</script>
<script type=module>  
import DB from './include/DB.js'
import {Markup} from './include/bey.js'

const observer = new IntersectionObserver(entries => entries.forEach(entry => entry.target.classList.toggle('seeing', entry.isIntersecting)));
Q('header').after(DB(() => Q('header,section,time,.scroller', el => observer.observe(el))));

class Shohin {
    constructor({code, name, imgs, desc, type, color, class: classList}) {
        imgs ??= [];
        if (name && /XG?-\d+/.test(code)) {
            let c = code.match(/.XG?-\d+/)[0].replace('-', '');
            imgs = [Shohin.base + `${c}@1.png`, ...imgs];
            imgs.push(...[2,3,4,5,6,7,8].map(n => Shohin.base + `${c}${color ? `_${color}` : ''}_0${n}@1.png`));
        }
        return E('div', [
            E('h5', type ? [
                E(`ruby.below.${type}`, [
                    E('img', {src: `img/types.svg#${type}`}), 
                    E('rt', Shohin.types[type])]),
                    code
                ] : code),
            E('h4', name?.replaceAll('-', 'â€‘').replaceAll('<br>', String.fromCharCode(10))), 
            ...imgs.map(src => E('figure', [E('a', 'ğŸ–¼ï¸', {href: src}), E('img', {src})])), 
            ...([desc ?? []].flat()).map(d => E('p', {innerHTML: Markup.spacing(d).replaceAll('-', 'â€‘')}))
        ], {classList: [`scroller`, classList || Shohin.classes.find(code, {default: 'Lm'})]});
    }
    static classes = new O([
        [/(stadium|entry) set/i, 'SS'],
        [/çµ„åˆ|Set/i, 'St'],
        [/Starter/i, 'S'],
        [/Random/i, 'RB'],
        [/Booster/i, 'B'],
        [/.XG?-/, 'others'],
    ])
    static base = `https://beyblade.takaratomy.co.jp/beyblade-x/lineup/_image/`;
    static types = {att: 'ATTACK', bal: 'BALANCE', sta: 'STAMINA', def: 'DEFENSE'};
}
DB.plugins = {
    announce: news => new O(news).each(([date, beys]) => 
        Q('#products').append(E('time', {title: date}), ...beys.map(bey => new Shohin(bey)))
    ),
};
import PointerInteraction from 'https://aeoq.github.io/pointer-interaction/script.js';
const reset = message => Promise.all([
    DB.discard(ev => message.innerText = ev.type == 'blocked' ? 'è«‹å…ˆé—œé–‰æ‰€æœ‰æœ¬ç¶²çš„åˆ†é ' : ev.type),
    caches.delete('V3'), caches.delete('parts'),
    localStorage.clear(),
    navigator.serviceWorker.getRegistrations().then(([reg]) => reg.unregister())
]);
PointerInteraction.events({
    '.scroller,#search ol': {scroll: {x: true}},
    '#reset': {
        drop: {goal: 'i:last-child'},
        drag: PI => PI.drag.to.translate({x: {min: 0, max: Q('#reboot p').clientWidth - Q('#reset').clientWidth}, y: false}),
        lift: PI => PI.goal && reset(PI.target.nextElementSibling).then(() => {
            onbeforeunload = () => scrollTo(0, 0);
            location.reload();
        }).catch(er => console.error(er)),
    }
});
(new Date - Storage('cached'))/1000/60/60/24 > 30 && fetch('sw/?delete=parts');
Q('body>input').onkeypress = ev => {
    if ((ev.keyCode || ev.which) != 13) return;
    ev.target.value = ev.target.value.trim();
    if (/^i#.+$/i.test(ev.target.value))
        return location.href = `https://instagram.com/explore/tags/${/(?<=#).+/.exec(ev.target.value)}`;
    if (/^i@.+$/i.test(ev.target.value))
        return location.href = `https://instagram.com/${/(?<=@).+/.exec(ev.target.value)}`;
    if (/^x\?.+$/i.test(ev.target.value))
        return location.href = `https://x.com/search?q=${/(?<=\?).+/.exec(ev.target.value)}&f=live`;
    if (/^x#.+$/i.test(ev.target.value))
        return location.href = `https://x.com/hashtag/${/(?<=#).+/.exec(ev.target.value)}/?f=live`;
    if (/^t\?.+$/i.test(ev.target.value))
        return location.href = `https://www.threads.net/search?q=${/(?<=\?).+/.exec(ev.target.value.replace('#', '%23'))}`;
    return location.href = `https://${ev.target.value}`;
}
</script>
